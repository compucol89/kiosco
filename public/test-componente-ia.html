<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Componente IA - KIOSCO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .resultado {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .debug {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Test Directo del Componente IA</h1>
        <p>Diagn√≥stico del estado del m√≥dulo de an√°lisis IA en el sistema.</p>
        
        <div>
            <button class="button" onclick="testCargaDatos()">üìä Test Carga de Datos</button>
            <button class="button" onclick="testComponenteIA()">üß† Test Componente IA</button>
            <button class="button" onclick="testOpenAI()">ü§ñ Test OpenAI Directo</button>
            <button class="button" onclick="simularInteraccion()">üéÆ Simular Interacci√≥n Usuario</button>
        </div>
        
        <div id="resultado" class="resultado" style="display: none;">
            <strong>Resultado:</strong><br>
            <div id="contenido-resultado"></div>
        </div>
    </div>

    <script>
        function mostrarResultado(contenido, tipo = '') {
            const resultado = document.getElementById('resultado');
            const contenidoDiv = document.getElementById('contenido-resultado');
            
            resultado.style.display = 'block';
            resultado.className = `resultado ${tipo}`;
            contenidoDiv.innerHTML = contenido;
        }

        async function testCargaDatos() {
            mostrarResultado('‚è≥ Verificando carga de datos desde la API...', 'loading');
            
            try {
                const response = await fetch('http://localhost/kiosco/api/reportes_financieros_precisos.php?filtro=hoy&usuario_id=1');
                const datos = await response.json();
                
                if (datos.success) {
                    mostrarResultado(`‚úÖ DATOS CARGADOS CORRECTAMENTE

üìä RESUMEN GENERAL:
‚Ä¢ Total Ventas: ${datos.resumen_general.total_ventas}
‚Ä¢ Utilidad Neta: $${datos.resumen_general.utilidad_neta}
‚Ä¢ Estado: ${datos.resumen_general.estado_negocio}
‚Ä¢ Margen: ${datos.resumen_general.margen_neto_porcentaje.toFixed(1)}%

üì¶ PRODUCTOS AN√ÅLISIS:
‚Ä¢ Cantidad: ${datos.productos_analisis.length}
‚Ä¢ Producto: ${datos.productos_analisis[0]?.nombre || 'N/A'}
‚Ä¢ Margen: ${datos.productos_analisis[0]?.margen_promedio.toFixed(1) || 'N/A'}%

üí≥ M√âTODOS DE PAGO:
‚Ä¢ Efectivo: $${datos.metodos_pago.efectivo}
‚Ä¢ Tarjeta: $${datos.metodos_pago.tarjeta}
‚Ä¢ Transferencia: $${datos.metodos_pago.transferencia}
‚Ä¢ QR: $${datos.metodos_pago.otros}

üîç ESTRUCTURA PARA IA:
{
  datos: { ‚úÖ Disponible },
  resumen: { ‚úÖ resumen_general },
  productos: { ‚úÖ productos_analisis },
  metodosPago: { ‚úÖ metodos_pago }
}

üéØ DIAGN√ìSTICO: Los datos est√°n perfectos para el an√°lisis IA`, 'success');
                } else {
                    mostrarResultado(`‚ùå ERROR EN DATOS: ${datos.message || 'Datos no v√°lidos'}`, 'error');
                }
            } catch (error) {
                mostrarResultado(`‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
            }
        }

        async function testComponenteIA() {
            mostrarResultado('üß™ Simulando comportamiento del componente AnalisisInteligente...', 'loading');
            
            // Simular el flujo del componente
            const simulacion = {
                paso1: "Componente recibe props: datos, resumen, productos",
                paso2: "useEffect detecta cambios en datos",
                paso3: "generarAnalisisIA() se ejecuta autom√°ticamente",
                paso4: "Valida si usar IA real o local",
                paso5: "Llama a OpenAI o algoritmos locales",
                paso6: "Procesa respuesta y actualiza estado",
                paso7: "Renderiza resultado en UI"
            };

            // Simular datos t√≠picos que recibe el componente
            const datosSimulados = {
                datos: {
                    resumenGeneral: { utilidad_neta: -5626.74 },
                    productos_analisis: [
                        { nombre: "Fernet Branca 450ml", margen_promedio: -9.74 }
                    ],
                    metodosPago: { efectivo: 27500, tarjeta: 9750 }
                },
                resumen: { utilidad_neta: -5626.74, estado_negocio: "EN P√âRDIDAS" },
                productos: [{ nombre: "Fernet Branca 450ml", margen_porcentaje: -9.74 }]
            };

            setTimeout(() => {
                mostrarResultado(`‚úÖ SIMULACI√ìN DEL COMPONENTE IA

üîÑ FLUJO DE EJECUCI√ìN:
${Object.entries(simulacion).map(([key, valor]) => `${key}: ${valor}`).join('\n')}

üìä DATOS SIMULADOS:
${JSON.stringify(datosSimulados, null, 2)}

üéØ RESULTADO ESPERADO:
‚Ä¢ Componente debe detectar p√©rdidas cr√≠ticas
‚Ä¢ IA debe identificar margen negativo en Fernet
‚Ä¢ Recomendaciones espec√≠ficas de precios
‚Ä¢ Score de salud bajo (25-30)

‚ùó POSIBLES PROBLEMAS:
1. useEffect no se ejecuta (dependencias incorrectas)
2. Datos no llegan en formato esperado
3. OpenAI service no se instancia correctamente
4. Estado loading no se maneja bien
5. Condiciones de renderizado restrictivas

üí° SOLUCI√ìN INMEDIATA: 
Agregar bot√≥n manual para forzar an√°lisis`, 'success');
            }, 2000);
        }

        async function testOpenAI() {
            mostrarResultado('ü§ñ Probando conexi√≥n directa con OpenAI...', 'loading');
            
            const API_KEY = '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';
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un experto consultor financiero para kioscos argentinos. Responde en JSON.'
                            },
                            {
                                role: 'user',
                                content: `Analiza este kiosco argentino:

RESUMEN: Utilidad Neta: $-5.626,74 | Margen: -9.7%
PRODUCTO: Fernet Branca 450ml con margen -9.74%

Responde en JSON:
{
  "diagnostico_principal": {
    "estado": "PERDIENDO",
    "problema_critico": "texto",
    "causa_principal": "texto"
  },
  "score_salud": 25,
  "soluciones_inmediatas": [
    {
      "accion": "texto espec√≠fico",
      "urgencia": "inmediata"
    }
  ]
}`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 800,
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    const analisis = JSON.parse(data.choices[0].message.content);
                    mostrarResultado(`‚úÖ OPENAI FUNCIONANDO PERFECTAMENTE

ü§ñ RESPUESTA IA:
${JSON.stringify(analisis, null, 2)}

üìà ESTAD√çSTICAS:
‚Ä¢ Tokens usados: ${data.usage.total_tokens}
‚Ä¢ Costo: $${(data.usage.total_tokens * 0.00015 / 1000).toFixed(6)}
‚Ä¢ Tiempo: ${Date.now() - performance.now()}ms

üéØ DIAGN√ìSTICO: OpenAI est√° operativo y respondiendo correctamente`, 'success');
                } else {
                    mostrarResultado(`‚ùå ERROR OPENAI: ${data.error?.message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                mostrarResultado(`‚ùå ERROR CONEXI√ìN OPENAI: ${error.message}`, 'error');
            }
        }

        async function simularInteraccion() {
            mostrarResultado('üéÆ Simulando interacci√≥n completa del usuario...', 'loading');
            
            let log = "SIMULACI√ìN PASO A PASO:\n\n";
            
            // Paso 1
            log += "üîÑ PASO 1: Usuario abre Reporte de Ventas\n";
            log += "‚Ä¢ Estado: pestanaActiva = 'resumen'\n";
            log += "‚Ä¢ Datos: loading = true\n\n";
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Paso 2
            log += "üìä PASO 2: API carga datos financieros\n";
            log += "‚Ä¢ reportesService.obtenerDatosContables()\n";
            log += "‚Ä¢ Datos procesados y mapeados\n";
            log += "‚Ä¢ Estado: loading = false, datos disponibles\n\n";
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Paso 3
            log += "üß† PASO 3: Usuario hace clic en pesta√±a 'An√°lisis IA'\n";
            log += "‚Ä¢ setPestanaActiva('ia')\n";
            log += "‚Ä¢ Renderiza componente AnalisisInteligente\n";
            log += "‚Ä¢ Props: datos={...}, resumen={...}, productos=[...]\n\n";
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Paso 4
            log += "‚öôÔ∏è PASO 4: Componente IA se inicializa\n";
            log += "‚Ä¢ useState: analisisIA = null, loading = false\n";
            log += "‚Ä¢ useEffect detecta datos disponibles\n";
            log += "‚Ä¢ Deber√≠a ejecutar generarAnalisisIA()\n\n";
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Paso 5
            log += "‚ùì PASO 5: PUNTO DE FALLO POSIBLE\n";
            log += "‚Ä¢ ¬øSe ejecuta generarAnalisisIA autom√°ticamente?\n";
            log += "‚Ä¢ ¬øO se queda esperando click manual?\n";
            log += "‚Ä¢ ¬øuseEffect tiene dependencias correctas?\n\n";
            
            mostrarResultado(log + `üéØ DIAGN√ìSTICO FINAL:

‚ùå PROBLEMA IDENTIFICADO: 
El componente probablemente no est√° ejecutando el an√°lisis autom√°ticamente.

üîß SOLUCIONES:
1. Verificar dependencias del useEffect
2. Agregar bot√≥n manual para forzar an√°lisis
3. Revisar logs de consola del navegador
4. Validar que datos lleguen en formato correcto

üí° ACCI√ìN INMEDIATA:
Abrir las herramientas de desarrollador (F12) y revisar la consola mientras navegas a la pesta√±a "An√°lisis IA"`, 'success');
        }
    </script>
</body>
</html>














