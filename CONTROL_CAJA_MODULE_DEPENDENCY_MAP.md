# üí∞ MAPA COMPLETO DE DEPENDENCIAS - M√ìDULO CONTROL DE CAJA

**Fecha de An√°lisis:** 8 de Octubre, 2025  
**Sistema:** Tayrona Almac√©n - Kiosco Management System  
**Prop√≥sito:** Mapeo exhaustivo y milim√©trico de todos los archivos y recursos del m√≥dulo Control de Caja

---

## üéØ RESUMEN EJECUTIVO

El m√≥dulo Control de Caja es el **CORAZ√ìN FINANCIERO** del sistema. Controla todo el flujo de efectivo, aperturas, cierres y movimientos.

**Componentes Principales:** 7 componentes React  
**Hooks Personalizados:** 4 hooks  
**Servicios:** 1 servicio  
**Endpoints Backend:** 1 archivo principal PHP con 15+ funciones  
**Tablas BD:** 4 tablas cr√≠ticas  
**Total de archivos mapeados:** 25+ archivos

‚ö†Ô∏è **ADVERTENCIA CR√çTICA:** Este m√≥dulo maneja dinero real. Cualquier error puede causar descuadres financieros.

---

## üìÅ 1. COMPONENTES FRONTEND (React/JSX)

### 1.1 Componente Principal

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | Dependencias Cr√≠ticas |
|---------|-----------|-----|-----------|----------------------|
| `GestionCajaMejorada.jsx` | `src/components/` | 1606 | **COMPONENTE PRINCIPAL** - Gesti√≥n completa de caja con apertura, cierre, movimientos | `AuthContext`, `CONFIG`, API: `gestion_caja_completa.php`, `pos_status.php` |

**Componentes internos de GestionCajaMejorada:**
- `FormularioAperturaElegante` - Formulario de apertura de caja
- `DashboardPrincipal` - Dashboard cuando caja est√° abierta
- `HistorialMovimientosMejorado` - Tabla de historial de movimientos
- `FormularioMovimientosMejorado` - Formulario para ingresos/egresos
- `ModalAperturaAmigable` - Modal mejorado de apertura

### 1.2 Componentes Auxiliares de Caja

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | Usado Por |
|---------|-----------|-----|-----------|-----------|
| `ModalAperturaCaja.jsx` | `src/components/` | 307 | Modal optimizado de apertura con verificaci√≥n manual en 2 fases | `GestionCajaMejorada` (alternativa) |
| `MetricasCaja.jsx` | `src/components/` | 220 | Componente modular para m√©tricas (efectivo, m√©todos pago, rendimiento) | Componentes de caja |
| `IndicadorEstadoCaja.jsx` | `src/components/` | 165 | Indicador de estado en tiempo real para barra superior | App principal, layout |
| `CajaStatusIndicator.jsx` | `src/components/` | 43 | Indicador compacto de estado de caja | App principal |
| `HistorialTurnosPage.jsx` | `src/components/` | 1131 | P√°gina completa de historial de turnos con 3 pesta√±as | Navegaci√≥n principal |
| `ReportesEfectivoPeriodo.jsx` | `src/components/` | 644+ | Reportes de efectivo por per√≠odo con an√°lisis de tendencias | `HistorialTurnosPage` (pesta√±a reportes) |
| `ReportesDiferenciasCajero.jsx` | `src/components/` | 468+ | Reportes de diferencias y performance por cajero | `HistorialTurnosPage` (pesta√±a cajeros) |

---

## üîß 2. HOOKS PERSONALIZADOS

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | Dependencias |
|---------|-----------|-----|-----------|--------------|
| `useCajaLogic.js` | `src/hooks/` | 173 | L√≥gica de negocio: c√°lculos, validaciones, formateo | Ninguna (pura l√≥gica) |
| `useCajaApi.js` | `src/hooks/` | 203 | Operaciones API: apertura, cierre, movimientos | `AuthContext`, `CONFIG`, API: `gestion_caja_completa.php` |
| `useCajaStatus.js` | `src/hooks/` | 357 | **HOOK CR√çTICO** - Estado en tiempo real con validaciones para bloquear ventas si caja cerrada | `cajaService`, circuit breaker, localStorage backup |
| `useDashboardStats` | Inline en `DashboardOptimizado.jsx` | ~40 | Hook para estad√≠sticas del dashboard | API: `dashboard_stats.php` |

---

## üåê 3. SERVICIOS

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | APIs Consumidas |
|---------|-----------|-----|-----------|-----------------|
| `cajaService.js` | `src/services/` | 429 | Servicio unificado con reintentos autom√°ticos, backoff exponencial, validaciones | `pos_status.php` |

**Funciones del servicio:**
- `getEstadoCaja()` - Con 3 reintentos autom√°ticos
- `abrirCaja()` - Apertura con validaciones
- `cerrarCaja()` - Cierre con c√°lculos
- `registrarMovimiento()` - Ingresos/egresos manuales
- `registrarVenta()` - Registro de ventas en caja
- `getUltimoCierre()` - √öltimo turno cerrado
- `getHistorialCierres()` - Historial completo
- `getMovimientos()` - Movimientos de caja
- Funciones de c√°lculo y formateo

---

## üóÑÔ∏è 4. CONTEXTOS DE REACT

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | Usado Por |
|---------|-----------|-----|-----------|-----------|
| `CajaContext.jsx` | `src/contexts/` | 199 | **CONTEXTO GLOBAL** - Estado compartido de caja en toda la app | M√∫ltiples componentes |

**Funcionalidades del contexto:**
- Estado global: `cajaAbierta`, `turnoActivo`
- Funciones: `abrirCaja()`, `cerrarCaja()`, `verificarEstadoCaja()`, `refrescarEstado()`
- Auto-refresh cada 30 segundos
- Persistencia en localStorage
- Cache de 10 segundos para evitar llamadas redundantes

---

## üîå 5. BACKEND API ENDPOINT PRINCIPAL

### 5.1 Archivo Principal

| Archivo | Ubicaci√≥n | LOC | Prop√≥sito | Tablas BD |
|---------|-----------|-----|-----------|----------|
| `gestion_caja_completa.php` | `api/` | 1330+ | **API COMPLETA** de gesti√≥n de caja con 15+ funciones | `turnos_caja`, `movimientos_caja_detallados`, `historial_turnos_caja`, `ventas`, `usuarios` |

### 5.2 Funciones GET del API

| Funci√≥n | Acci√≥n GET | Prop√≥sito | Usado Por |
|---------|-----------|-----------|-----------|
| `obtenerEstadoCaja()` | `estado_caja` | Estado actual de caja con turno activo y c√°lculos | `GestionCajaMejorada`, `CajaContext` |
| `obtenerEstadoCompleto()` | `estado_completo` | Estado con movimientos y estad√≠sticas | `useCajaApi` |
| `obtenerTurnoActivo()` | `turno_activo` | Datos del turno activo con ventas y movimientos | Componentes de caja |
| `obtenerHistorialMovimientos()` | `historial_movimientos` | Movimientos del turno actual (apertura + ventas + manuales) | `GestionCajaMejorada` |
| `obtenerResumenMetodosPago()` | `resumen_metodos_pago` | Ventas agrupadas por m√©todo de pago | Dashboard de caja |
| `obtenerHistorialTurnos()` | `historial_turnos` | Lista de turnos hist√≥ricos | Legacy |
| `obtenerUltimoCierre()` | `ultimo_cierre` | √öltimo turno cerrado para referencia | `ModalAperturaCaja`, `GestionCajaMejorada` |
| `obtenerHistorialCompleto()` | `historial_completo` | Historial completo con filtros, paginaci√≥n, estad√≠sticas | `HistorialTurnosPage` |
| `validarTurnoUnico()` | `validar_turno_unico` | Validar que no haya turnos duplicados abiertos | Sistema de validaci√≥n |
| `obtenerResumenMovimientosTurno()` | `resumen_movimientos_turno` | Resumen detallado de un turno espec√≠fico | Modal detalle en `HistorialTurnosPage` |

### 5.3 Funciones POST del API

| Funci√≥n | Acci√≥n POST | Prop√≥sito | Validaciones Cr√≠ticas |
|---------|------------|-----------|----------------------|
| `abrirCaja()` | `abrir_caja` | Apertura de caja con verificaci√≥n manual obligatoria | Verifica turno √∫nico, efectivo esperado vs contado, diferencia de apertura |
| `cerrarCaja()` | `cerrar_caja` | Cierre de caja con c√°lculo autom√°tico de diferencias | Valida turno activo, calcula diferencia exacta, registra en historial |
| `registrarMovimiento()` | `registrar_movimiento` | Registrar ingreso/egreso manual de efectivo | Valida turno activo, monto positivo, categor√≠a v√°lida |
| `cerrarTurnoEmergencia()` | `cerrar_turno_emergencia` | Resolver inconsistencias cerrando turnos hu√©rfanos | Solo para recuperaci√≥n de errores |

---

## üóÉÔ∏è 6. TABLAS DE BASE DE DATOS

### 6.1 Tabla Principal: `turnos_caja`

**Prop√≥sito:** Registro de todos los turnos de caja (apertura/cierre)

**Campos Cr√≠ticos:**
- `id` (PK) - Identificador √∫nico del turno
- `usuario_id` (FK) - Cajero responsable
- `numero_turno` - N√∫mero secuencial del turno
- `estado` - `'abierto'` o `'cerrado'` ‚ö†Ô∏è CR√çTICO - case-sensitive
- `tipo_turno` - `'MA√ëANA'`, `'TARDE'`, `'NOCHE'` - Para sistema doble turno
- `fecha_apertura` - Timestamp de apertura
- `fecha_cierre` - Timestamp de cierre (NULL si abierto)
- `monto_apertura` - Efectivo inicial del turno
- `monto_cierre` - Efectivo contado al cerrar
- `efectivo_teorico` - Efectivo que DEBER√çA haber (calculado)
- `diferencia` - `monto_cierre - efectivo_teorico`
- `ventas_efectivo` - Total ventas en efectivo del turno
- `ventas_transferencia` - Total ventas por transferencia
- `ventas_tarjeta` - Total ventas con tarjeta
- `ventas_qr` - Total ventas con QR
- `notas` - Observaciones del turno

**C√°lculos Autom√°ticos en Queries:**
```sql
efectivo_teorico = monto_apertura + entradas_efectivo + ventas_efectivo_reales - salidas_efectivo
diferencia = monto_cierre - efectivo_teorico
```

### 6.2 Tabla de Movimientos: `movimientos_caja_detallados`

**Prop√≥sito:** Registro de cada movimiento manual de efectivo

**Campos Cr√≠ticos:**
- `id` (PK)
- `turno_id` (FK) - Relaci√≥n con `turnos_caja`
- `tipo` - `'ingreso'` o `'egreso'` ‚ö†Ô∏è CR√çTICO
- `categoria` - Categor√≠a del movimiento
- `monto` - Valor del movimiento (positivo para ingresos, negativo para egresos)
- `descripcion` - Detalle del movimiento
- `referencia` - N√∫mero de factura, comprobante, etc.
- `usuario_id` (FK) - Usuario que registr√≥ el movimiento
- `fecha_movimiento` - Timestamp del movimiento

**Categor√≠as v√°lidas:**
- **Ingresos:** `'Venta Efectivo'`, `'Dep√≥sito'`, `'Ajuste Positivo'`, `'Devoluci√≥n'`, `'Otros Ingresos'`
- **Egresos:** `'Mercader√≠a'`, `'Retiro Efectivo'`, `'Pago Servicios'`, `'Gastos Varios'`, `'Otros Egresos'`

### 6.3 Tabla de Historial: `historial_turnos_caja`

**Prop√≥sito:** Registro hist√≥rico de cada evento (apertura/cierre) para trazabilidad

**Campos Cr√≠ticos:**
- `id` (PK)
- `numero_turno` - N√∫mero del turno
- `cajero_id` (FK) - Usuario cajero
- `cajero_nombre` - Nombre del cajero (desnormalizado)
- `tipo_evento` - `'apertura'` o `'cierre'` ‚ö†Ô∏è CR√çTICO
- `fecha_hora` - Timestamp del evento
- `monto_inicial` - Monto de apertura (si es apertura)
- `monto_final` - Efectivo te√≥rico (si es cierre)
- `efectivo_teorico` - Efectivo calculado
- `efectivo_contado` - Efectivo f√≠sico contado
- `diferencia` - Diferencia detectada
- `tipo_diferencia` - `'exacto'`, `'sobrante'`, `'faltante'`
- `duracion_turno_minutos` - Duraci√≥n del turno
- `cantidad_transacciones` - N√∫mero de ventas del turno
- `total_ventas` - Suma de ventas del turno

### 6.4 Relaciones con Otras Tablas

| Tabla | Relaci√≥n | Prop√≥sito |
|-------|----------|-----------|
| `ventas` | Filtradas por `fecha >= turnos_caja.fecha_apertura` | Ventas asociadas al turno para calcular efectivo teorico |
| `usuarios` | `turnos_caja.usuario_id = usuarios.id` | Informaci√≥n del cajero |

---

## üîÑ 7. FLUJO DE DATOS DEL M√ìDULO

### 7.1 Flujo de Apertura de Caja

```
Usuario hace clic en "Abrir Caja"
    ‚Üì
GestionCajaMejorada.jsx ‚Üí abrirModalApertura()
    ‚Üì
Obtiene √∫ltimo cierre: API gestion_caja_completa.php?accion=ultimo_cierre
    ‚Üì
Muestra ModalAperturaAmigable con datos del √∫ltimo cierre
    ‚Üì
Usuario ingresa monto inicial
    ‚Üì
procesarAperturaCaja() ‚Üí API gestion_caja_completa.php?accion=abrir_caja (FASE 1)
    ‚Üì
Backend retorna: requiere_verificacion = true
    ‚Üì
Frontend muestra prompt para contar efectivo f√≠sico
    ‚Üì
Usuario ingresa efectivo contado
    ‚Üì
API gestion_caja_completa.php?accion=abrir_caja (FASE 2 con efectivo_contado)
    ‚Üì
Backend:
  - Valida turno √∫nico
  - Calcula diferencia_apertura = efectivo_contado - efectivo_esperado
  - INSERT en turnos_caja con estado='abierto'
  - INSERT en historial_turnos_caja tipo_evento='apertura'
    ‚Üì
Frontend: Refresca datos, muestra Dashboard Principal
```

### 7.2 Flujo de Cierre de Caja

```
Usuario hace clic en "Cerrar Caja"
    ‚Üì
DashboardPrincipal ‚Üí abrirModalCierre()
    ‚Üì
Muestra modal con resumen detallado del turno
    ‚Üì
Usuario ingresa efectivo contado f√≠sicamente
    ‚Üì
procesarCierreCaja() ‚Üí calcularEfectivoEsperado() (FUNCI√ìN CR√çTICA)
    ‚Üì
Calcula: efectivo_esperado = total_entradas_efectivo - salidas_efectivo_reales
    ‚Üì
Calcula: diferencia = efectivo_contado - efectivo_esperado
    ‚Üì
API gestion_caja_completa.php?accion=cerrar_caja
    ‚Üì
Backend:
  - Obtiene turno activo
  - UPDATE turnos_caja SET estado='cerrado', monto_cierre, diferencia, fecha_cierre
  - INSERT en historial_turnos_caja tipo_evento='cierre'
    ‚Üì
Frontend: Muestra resumen, refresca, vuelve a vista de caja cerrada
```

### 7.3 Flujo de Registro de Movimiento

```
Usuario rellena formulario de movimiento
    ‚Üì
FormularioMovimientosMejorado ‚Üí handleSubmit()
    ‚Üì
Valida: tipo, categor√≠a, monto, descripci√≥n
    ‚Üì
API gestion_caja_completa.php?accion=registrar_movimiento
    ‚Üì
Backend:
  - Valida turno activo
  - INSERT en movimientos_caja_detallados
  - UPDATE turnos_caja columnas calculadas
    ‚Üì
Frontend: Refresca movimientos, limpia formulario
```

---

## üé® 8. FUNCIONES CR√çTICAS - NO MODIFICAR

### 8.1 Frontend (GestionCajaMejorada.jsx)

#### `calcularEfectivoEsperado(datosControl)` - L√≠neas 270-300

**‚ö†Ô∏è FUNCI√ìN ULTRA CR√çTICA**

```javascript
const calcularEfectivoEsperado = (datosControl) => {
  // Preferencia 1: Usar efectivo_teorico del backend
  const efectivoTeorico = datosControl?.turno?.efectivo_teorico || 
                         datosControl?.efectivo_teorico || 0;
  
  // Fallback: C√°lculo manual
  const apertura = datosControl?.monto_apertura || 0;
  const entradas = datosControl?.total_entradas_efectivo || 0;  
  const salidas = Math.abs(datosControl?.salidas_efectivo_reales || 0);
  const fallbackCalculo = entradas - salidas;
  
  return efectivoTeorico > 0 ? efectivoTeorico : fallbackCalculo;
};
```

**Usado en:** Modal de cierre, c√°lculo de diferencias  
**NO MODIFICAR SIN VALIDAR:** Cambios aqu√≠ afectan todos los cierres de caja

#### `procesarCierreCaja()` - L√≠neas 303-390

**Funci√≥n que ejecuta el cierre completo:**
- Valida efectivo contado
- Calcula efectivo esperado
- Calcula diferencia exacta SIN REDONDEOS
- Env√≠a datos a API
- Muestra resumen al usuario

### 8.2 Backend (gestion_caja_completa.php)

#### Funci√≥n `abrirCaja()` - L√≠neas 674-901

**L√≥gica de 2 fases:**
1. **Fase 1:** Verificar si hay √∫ltimo cierre ‚Üí retornar `requiere_verificacion: true`
2. **Fase 2:** Recibir `efectivo_contado`, calcular diferencia de apertura, crear turno

**Validaciones:**
- Solo 1 turno abierto por usuario
- Efectivo contado vs esperado
- Registrar diferencia de apertura en notas

#### Funci√≥n `cerrarCaja()` - L√≠neas 902-952+

**L√≥gica cr√≠tica:**
- Validar turno activo
- Calcular diferencia: `monto_cierre - efectivo_teorico`
- UPDATE sin redondeos forzados
- INSERT en historial

**‚ö†Ô∏è NO USAR `floatval()` en monto_cierre - preservar exactitud decimal**

#### Funci√≥n `obtenerEstadoCaja()` - L√≠neas 326-404

**Query principal con LEFT JOINs:**
```sql
SELECT t.*, 
  SUM(CASE WHEN m.tipo = 'ingreso' THEN m.monto ELSE 0 END) as entradas_efectivo,
  SUM(CASE WHEN m.tipo = 'egreso' THEN ABS(m.monto) ELSE 0 END) as salidas_efectivo,
  (SELECT SUM(monto_total) FROM ventas WHERE metodo_pago = 'efectivo' 
   AND fecha >= t.fecha_apertura AND fecha <= t.fecha_cierre) as ventas_efectivo_reales
FROM turnos_caja t
LEFT JOIN movimientos_caja_detallados m ON t.id = m.turno_id
WHERE t.usuario_id = ? AND t.estado = 'abierto'
```

**C√°lculo en PHP:**
```php
$efectivoTeorico = $turno['monto_apertura'] + $turno['entradas_efectivo'] + 
                   $turno['ventas_efectivo_reales'] - $turno['salidas_efectivo'];
```

---

## üîê 9. VALIDACIONES Y REGLAS DE NEGOCIO

### 9.1 Reglas de Apertura

‚úÖ **Permitido:**
- Abrir caja si no hay turnos abiertos
- Primera apertura sin verificaci√≥n (no hay cierre anterior)
- Apertura con diferencia respecto al √∫ltimo cierre (registrada)

‚ùå **Bloqueado:**
- Abrir si ya hay un turno abierto del mismo usuario
- Abrir sin verificar efectivo f√≠sico (si hay cierre anterior)

### 9.2 Reglas de Cierre

‚úÖ **Permitido:**
- Cerrar con cualquier diferencia (se registra)
- Cerrar con observaciones
- Diferencias exactas (diferencia = 0)

‚ùå **Bloqueado:**
- Cerrar sin turno abierto
- Cerrar sin ingresar efectivo contado
- Cerrar con monto negativo

### 9.3 Reglas de Movimientos

‚úÖ **Permitido:**
- Ingresos/egresos con turno abierto
- M√∫ltiples movimientos en un turno
- Montos con decimales

‚ùå **Bloqueado:**
- Movimientos sin turno abierto
- Montos negativos en el input (el tipo define si es ingreso/egreso)
- Sin descripci√≥n

---

## üìä 10. ESTRUCTURA DE DATOS CR√çTICA

### 10.1 Objeto `datosControl` (Frontend)

```javascript
{
  // Datos del turno
  id: number,
  usuario_id: number,
  numero_turno: number,
  estado: 'abierto' | 'cerrado',
  tipo_turno: 'MA√ëANA' | 'TARDE' | 'NOCHE',
  fecha_apertura: datetime,
  fecha_cierre: datetime | null,
  cajero_nombre: string,
  
  // Montos del turno
  monto_apertura: float,
  monto_cierre: float | null,
  efectivo_teorico: float, // CR√çTICO - calculado por backend
  diferencia: float | null,
  
  // Ventas por m√©todo
  ventas_efectivo: float,
  ventas_efectivo_reales: float, // REAL desde BD
  ventas_transferencia: float,
  ventas_transferencia_reales: float,
  ventas_tarjeta: float,
  ventas_tarjeta_reales: float,
  ventas_qr: float,
  ventas_qr_reales: float,
  total_ventas_hoy: float,
  
  // Movimientos manuales
  entradas_efectivo: float, // Solo movimientos manuales
  salidas_efectivo_reales: float, // Solo egresos
  total_entradas_efectivo: float, // ventas_efectivo + entradas_efectivo
  movimientos_manuales: number,
  
  // Referencia completa
  turno: { ...todos_los_campos } // Objeto completo del turno
}
```

### 10.2 Objeto `movimiento` (BD y Frontend)

```javascript
{
  id: number,
  turno_id: number,
  tipo: 'ingreso' | 'egreso' | 'venta' | 'apertura',
  categoria: string,
  monto: float,
  descripcion: string,
  referencia: string,
  usuario_id: number,
  fecha_movimiento: datetime,
  fecha_formateada: string, // 'dd/mm HH:MM'
  usuario_nombre: string
}
```

---

## üö® 11. PUNTOS CR√çTICOS - NO TOCAR

### ‚ö†Ô∏è C√ìDIGO ULTRA SENSIBLE

1. **calcularEfectivoEsperado() en GestionCajaMejorada.jsx (l√≠neas 270-300)**
   - Cualquier cambio rompe los cierres de caja
   - Afecta el c√°lculo de diferencias
   - Se usa en modal de cierre

2. **Funci√≥n abrirCaja() en gestion_caja_completa.php (l√≠neas 674-901)**
   - L√≥gica de 2 fases con verificaci√≥n manual
   - C√°lculos de diferencia de apertura
   - INSERT en m√∫ltiples tablas

3. **Funci√≥n cerrarCaja() en gestion_caja_completa.php (l√≠neas 902-952+)**
   - C√°lculo de diferencia final
   - UPDATE de estado del turno
   - INSERT en historial

4. **Query de obtenerEstadoCaja() (l√≠neas 330-376)**
   - JOIN complejo con c√°lculos agregados
   - Subquery para ventas en efectivo
   - Usado por toda la aplicaci√≥n

5. **Campo estado en turnos_caja**
   - Solo valores: `'abierto'` o `'cerrado'` (lowercase)
   - Case-sensitive en todas las queries
   - Cambiar esto rompe TODO

### üîí Integridad Financiera

**Campos que NO se deben modificar directamente:**
- `efectivo_teorico` - Siempre calculado
- `diferencia` - Siempre calculado como `monto_cierre - efectivo_teorico`
- `ventas_efectivo_reales` - Suma desde tabla `ventas`

**Validaciones autom√°ticas:**
- Solo 1 turno abierto por usuario simult√°neamente
- Diferencias registradas y auditadas
- Historial inmutable (INSERT only, no UPDATE/DELETE)

---

## üéØ 12. DEPENDENCIAS EXTERNAS

### 12.1 Iconos (lucide-react)

**Iconos espec√≠ficos de Control de Caja:**
- `Calculator`, `Lock`, `Unlock` - Estados de caja
- `TrendingUp`, `TrendingDown` - Ingresos/Egresos
- `DollarSign`, `Banknote`, `CreditCard` - M√©todos de pago
- `Plus`, `Minus` - Acciones de movimientos
- `Clock`, `Calendar` - Tiempo y fechas
- `User` - Cajero
- `Receipt` - Movimientos
- `CheckCircle`, `AlertTriangle` - Estados y alertas
- `RefreshCw` - Actualizaci√≥n
- `Eye` - Ver detalles
- `Download` - Exportar reportes

### 12.2 Contextos Compartidos

| Contexto | Prop√≥sito | Datos Cr√≠ticos |
|----------|-----------|----------------|
| `AuthContext` | Usuario actual | `user.id`, `user.nombre` - Usado en todos los endpoints |
| `CajaContext` | Estado global de caja | `cajaAbierta`, `turnoActivo` - Compartido entre componentes |

---

## üß™ 13. ARCHIVOS DE TESTING Y DEBUG

| Archivo | Ubicaci√≥n | Prop√≥sito |
|---------|-----------|-----------|
| `test_query_directa.php` | `api/` | Test de queries de caja |
| `test_flujo_completo_automatico.php` | `api/` | Test autom√°tico del flujo apertura‚Üíventa‚Üícierre |
| `completar_apertura_verificacion.php` | `api/` | Script de verificaci√≥n de aperturas |
| `test_ciclo_completo_turnos.php` | `api/` | Test del ciclo completo de turnos |
| `test_completo_control_caja.php` | `api/` | Test integral de control de caja |
| `test_movimientos_caja_corregido.php` | `api/` | Test de movimientos corregidos |
| `auto_turno_checker.php` | `api/` | Verificador autom√°tico de turnos |
| `sistema_traspaso_turnos.php` | `api/` | Sistema de traspaso entre turnos |
| `logica_continuidad_turnos.php` | `api/` | L√≥gica de continuidad empresarial |
| `fix_efectivo_teorico.php` | `api/` | Script para corregir efectivo te√≥rico |
| `verificar_estructura_turnos_caja.php` | `api/` | Verificador de estructura de tabla |
| `crear_tabla_turnos_caja.php` | `api/` | Script de creaci√≥n de tabla |

---

## üìù 14. FUNCIONES DE C√ÅLCULO FINANCIERO

### 14.1 C√°lculos en Frontend

| Funci√≥n | Archivo | Prop√≥sito | F√≥rmula |
|---------|---------|-----------|---------|
| `calcularEfectivoEsperado()` | `GestionCajaMejorada.jsx` | Efectivo que deber√≠a haber | `total_entradas_efectivo - salidas_efectivo_reales` |
| `calcularArqueoAcumulativo()` | `HistorialTurnosPage.jsx` | Balance corrido de efectivo | Balance anterior ¬± flujo del evento |
| `calcularEfectivoRealPeriodo()` | `HistorialTurnosPage.jsx` | Efectivo real que debe haber hoy | Basado en √∫ltimo cierre o apertura actual |
| `efectivoEsperado` (useMemo) | `useCajaLogic.js` | Optimizado con memoizaci√≥n | `montoInicial + totalEntradas - salidasEfectivo` |
| `flujoEfectivo` (useMemo) | `useCajaLogic.js` | Flujo de efectivo del turno | `{ inicial, entradas, salidas, actual }` |

### 14.2 C√°lculos en Backend

| C√°lculo | Funci√≥n | SQL/PHP | Prop√≥sito |
|---------|---------|---------|-----------|
| Efectivo te√≥rico | `obtenerEstadoCaja()` | `monto_apertura + entradas_efectivo + ventas_efectivo_reales - salidas_efectivo` | Efectivo que DEBE haber |
| Diferencia | `cerrarCaja()` | `monto_cierre - efectivo_teorico` | Faltante/sobrante |
| Ventas efectivo reales | Subquery | `SELECT SUM(monto_total) FROM ventas WHERE metodo_pago='efectivo' AND fecha >= turno.fecha_apertura` | Ventas reales del turno |
| Total entradas efectivo | Agregaci√≥n | `SUM(CASE WHEN tipo='ingreso' THEN monto ELSE 0 END)` | Ingresos manuales |
| Total salidas efectivo | Agregaci√≥n | `SUM(CASE WHEN tipo='egreso' THEN ABS(monto) ELSE 0 END)` | Egresos |

---

## üîó 15. INTEGRACIONES CON OTROS M√ìDULOS

| M√≥dulo | Integraci√≥n | Archivo | Prop√≥sito |
|--------|-------------|---------|-----------|
| **POS/Ventas** | Ventas registran movimientos en caja | `procesar_venta_ultra_rapida.php` | Al completar venta, se actualiza `turnos_caja.ventas_efectivo` |
| **Dashboard** | Lee estado de caja | `DashboardResumenCaja.jsx` | Muestra efectivo disponible, estado |
| **App Principal** | Valida caja abierta antes de vender | `App.jsx` | Usa `CajaContext` para bloquear POS |
| **Reportes** | Lee datos de turnos | `reportesService.js` | Para reportes financieros |

---

## ‚ö° 16. PERFORMANCE Y OPTIMIZACIONES

### 16.1 Caching y Performance

- **CajaContext:** Cache de 10 segundos para evitar llamadas redundantes
- **useCajaStatus:** Circuit breaker para evitar sobrecarga de API
- **IndicadorEstadoCaja:** Actualizaci√≥n cada 15 segundos
- **localStorage backup:** Estado persistente para modo offline
- **Debounce:** En HistorialTurnosPage para filtros

### 16.2 Queries Optimizadas

- **LEFT JOIN** en lugar de m√∫ltiples queries
- **Subqueries** para ventas en efectivo (m√°s r√°pido que JOIN)
- **√çndices requeridos:** `turnos_caja(usuario_id, estado)`, `ventas(metodo_pago, fecha)`
- **LIMIT** en todas las queries de listado

---

## üìã 17. CONFIGURACI√ìN Y CONSTANTES

### 17.1 Categor√≠as de Movimientos

**Definidas en:** `GestionCajaMejorada.jsx` l√≠neas 897-900

```javascript
const categorias = {
  ingreso: ['Venta Efectivo', 'Dep√≥sito', 'Ajuste Positivo', 'Devoluci√≥n', 'Otros Ingresos'],
  egreso: ['Mercader√≠a', 'Retiro Efectivo', 'Pago Servicios', 'Gastos Varios', 'Otros Egresos']
};
```

### 17.2 Tipos de Turno

**Valores v√°lidos:** `'MA√ëANA'`, `'TARDE'`, `'NOCHE'`  
**Usado en:** Sistema empresarial de doble turno  
**Afecta:** Filtrado de ventas y movimientos por horario

### 17.3 Montos R√°pidos

**Definidos en:** M√∫ltiples componentes

```javascript
const montosRapidos = [5000, 10000, 15000, 20000, 50000];
```

---

## üé® 18. COMPONENTES UI REUTILIZABLES

| Componente | Archivo | Props Cr√≠ticas | Usado En |
|------------|---------|----------------|----------|
| `TarjetaMetrica` | `MetricasCaja.jsx` | `titulo, valor, icono, color, prefijo` | M√©tricas de efectivo, m√©todos pago, rendimiento |
| `TarjetaModerna` | `GestionCajaMejorada.jsx` | `titulo, valor, subtitulo, icono, color` | Dashboard principal |
| `ModalAperturaAmigable` | `GestionCajaMejorada.jsx` | `datos, ultimoCierre, onConfirmar` | Apertura de caja |

---

## üîç 19. ENDPOINTS DE SOPORTE

| Archivo | Ubicaci√≥n | Prop√≥sito | Usado Por |
|---------|-----------|-----------|-----------|
| `pos_status.php` | `api/` | Estado r√°pido de caja para POS | `cajaService`, `IndicadorEstadoCaja`, `HistorialTurnosPage` |
| `verificar_consistencia_dashboard.php` | `api/` | Verificaci√≥n de consistencia | Sistema de validaci√≥n |
| `debug_ventas_efectivo.php` | `api/` | Debug de ventas en efectivo | Troubleshooting |
| `debug_salidas_detalle.php` | `api/` | Debug de salidas de efectivo | Troubleshooting |
| `verificar_turnos_y_ventas.php` | `api/` | Validaci√≥n de relaci√≥n turnos-ventas | Auditor√≠a |
| `validar_integridad_reportes.php` | `api/` | Validaci√≥n de integridad financiera | Reportes |

---

## üîÑ 20. ESTADOS Y CICLO DE VIDA

### 20.1 Estados de Turno

```
CERRADO ‚Üí (Abrir Caja) ‚Üí ABIERTO ‚Üí (Cerrar Caja) ‚Üí CERRADO
    ‚Üë                          ‚Üì
    ‚îî‚îÄ‚îÄ (Nuevo Turno) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 20.2 Estados de Componente

**GestionCajaMejorada:**
- `loading` - Cargando datos
- `cajaAbierta` - boolean
- `datosControl` - Objeto completo del turno
- `showModalApertura` - Modal visible
- `showModalCierre` - Modal visible (interno a DashboardPrincipal)
- `movimientos` - Array de movimientos
- `procesandoApertura` - Procesando apertura
- `procesandoCierre` - Procesando cierre

---

## üìû 21. ENDPOINTS Y SUS PAR√ÅMETROS

### GET Endpoints

```
api/gestion_caja_completa.php?accion=estado_caja&usuario_id={id}
api/gestion_caja_completa.php?accion=estado_completo&usuario_id={id}
api/gestion_caja_completa.php?accion=turno_activo&usuario_id={id}
api/gestion_caja_completa.php?accion=historial_movimientos&usuario_id={id}&limite={n}
api/gestion_caja_completa.php?accion=ultimo_cierre&usuario_id={id}
api/gestion_caja_completa.php?accion=historial_completo&usuario_id={id}&limite={n}&pagina={n}&fecha_inicio={date}&fecha_fin={date}&tipo_evento={tipo}&cajero_id={id}
api/gestion_caja_completa.php?accion=resumen_movimientos_turno&numero_turno={n}
```

### POST Endpoints

```
POST api/gestion_caja_completa.php?accion=abrir_caja
Body: { usuario_id, monto_apertura, notas, efectivo_contado? }

POST api/gestion_caja_completa.php?accion=cerrar_caja
Body: { usuario_id, monto_cierre, notas }

POST api/gestion_caja_completa.php?accion=registrar_movimiento
Body: { usuario_id, tipo, categoria, monto, descripcion, referencia }

POST api/gestion_caja_completa.php?accion=cerrar_turno_emergencia
Body: { usuario_id }
```

---

## üõ°Ô∏è 22. MECANISMOS DE SEGURIDAD

### 22.1 Validaciones Frontend

- Input validation con regex: `/^\d*\.?\d*$/` para montos
- Confirmaciones antes de cerrar caja
- Validaci√≥n de turno √∫nico en `CajaContext`
- Circuit breaker en `useCajaStatus` para evitar sobrecarga

### 22.2 Validaciones Backend

- Validaci√≥n de turno √∫nico con query `WHERE estado='abierto' AND usuario_id=?`
- Validaci√≥n de JSON input
- Validaci√≥n de montos >= 0
- Manejo de excepciones con try/catch
- Logs de todas las operaciones cr√≠ticas

### 22.3 Recuperaci√≥n de Errores

- **Modo Fallback:** `useCajaStatus` usa localStorage si API falla
- **Reintentos autom√°ticos:** `cajaService.getEstadoCaja()` intenta 3 veces
- **Backoff exponencial:** Espera creciente entre reintentos
- **Cierre de emergencia:** `cerrar_turno_emergencia` para resolver inconsistencias

---

## üìä 23. REPORTES INTEGRADOS

### 23.1 Historial de Turnos

**Componente:** `HistorialTurnosPage.jsx`

**Pesta√±as:**
1. **Historial de Turnos** - Lista completa con filtros y paginaci√≥n
2. **Reportes por Per√≠odo** - `ReportesEfectivoPeriodo.jsx`
3. **Diferencias por Cajero** - `ReportesDiferenciasCajero.jsx`

**Funcionalidades:**
- Filtros: fecha inicio/fin, tipo evento, cajero
- Paginaci√≥n: 25 registros por p√°gina
- Estad√≠sticas: total eventos, turnos √∫nicos, cierres exactos, diferencia total
- An√°lisis de efectivo real del per√≠odo
- Arqueo acumulativo (balance running)
- Modal de detalle por turno con resumen de movimientos

### 23.2 Reportes de Efectivo

**Componente:** `ReportesEfectivoPeriodo.jsx`

**M√©tricas:**
- Efectivo inicial/final del per√≠odo
- Movimientos netos
- Diferencias acumuladas
- An√°lisis de tendencias
- Agrupaci√≥n por d√≠a/semana/mes

### 23.3 Reportes por Cajero

**Componente:** `ReportesDiferenciasCajero.jsx`

**M√©tricas:**
- Performance por cajero
- Tasa de precisi√≥n
- Diferencias acumuladas
- Promedio de diferencias
- Ranking de cajeros

---

## üîß 24. FUNCIONES UTILITARIAS

### 24.1 useCajaLogic.js

```javascript
efectivoEsperado - Calcular efectivo esperado
resumenVentas - Resumen por m√©todo con porcentajes
flujoEfectivo - Flujo de entradas/salidas
tiempoTurno - Duraci√≥n del turno
metricas - Ventas por hora, tiempo transcurrido
validarDatosCierre() - Validar antes de cerrar
formatearMoneda() - Formato argentino
prepararResumen() - Datos para modal de cierre
```

### 24.2 cajaService.js

```javascript
getEstadoCaja() - Con 3 reintentos y timeout de 10s
calcularEfectivoFisico() - Efectivo disponible
calcularTotalDigital() - Suma de m√©todos digitales
getResumenMetodosPago() - Resumen formateado
hayCajaAbierta() - Validaci√≥n booleana
formatearResumen() - Formateo para UI
```

---

## üöÄ 25. CARACTER√çSTICAS ENTERPRISE

### 25.1 Sistema de Doble Turno

- Turnos: MA√ëANA (8:00-16:00), TARDE (16:00-00:00)
- Campo `tipo_turno` en `turnos_caja`
- L√≥gica en `obtenerHistorialMovimientos()` para filtrar por horario
- Trazabilidad completa entre turnos

### 25.2 Trazabilidad Completa

- Tabla `historial_turnos_caja` - Registro inmutable de eventos
- Cada apertura y cierre registrado
- Auditor√≠a de diferencias
- Campos: cajero, fecha, montos, diferencias, duraci√≥n

### 25.3 Validaci√≥n Financiera

- Comparaci√≥n efectivo esperado vs contado
- Registro de diferencias en apertura
- Clasificaci√≥n de diferencias: Perfecto, Aceptable, Alto, Cr√≠tico
- Alertas autom√°ticas por diferencias significativas

---

## üéØ 26. RECOMENDACIONES PARA DEPURACI√ìN

### Al Modificar Componentes Frontend:

1. ‚úÖ **SIEMPRE leer el componente completo** antes de modificar
2. ‚úÖ **Verificar la funci√≥n `calcularEfectivoEsperado()`** si tocas c√°lculos
3. ‚úÖ **Probar flujo completo:** Apertura ‚Üí Movimientos ‚Üí Cierre
4. ‚úÖ **Validar con datos reales** de la BD de producci√≥n
5. ‚úÖ **Revisar logs de console.log** para debugging

### Al Modificar Backend:

1. ‚úÖ **NO cambiar c√°lculo de `efectivo_teorico`** sin validar TODO el sistema
2. ‚úÖ **Mantener formato de respuesta JSON** compatible
3. ‚úÖ **NO eliminar campos** de las tablas sin actualizar frontend
4. ‚úÖ **Testear con scripts de testing** antes de deploy
5. ‚úÖ **Verificar que queries usen √≠ndices** correctos

### Al Modificar Base de Datos:

1. üö® **NO cambiar nombres de tablas** (`turnos_caja`, `movimientos_caja_detallados`, `historial_turnos_caja`)
2. üö® **NO eliminar campos** sin verificar 25+ archivos
3. üö® **NO cambiar tipos de datos** de campos financieros
4. üö® **Agregar campos** solo con DEFAULT o NULL
5. üö® **Crear backups** antes de cualquier modificaci√≥n

---

## üé® 27. ESTILOS Y UI

### 27.1 Colores por Tipo

**Estados de caja:**
- Verde: Caja abierta, exacto, ingresos
- Rojo: Caja cerrada, faltante, egresos
- Azul: Informaci√≥n, neutral
- Amarillo: Advertencias, verificaciones
- Naranja: Cr√≠tico, requiere atenci√≥n

**M√©todos de pago:**
- Verde: Efectivo
- Azul: Transferencia
- P√∫rpura: Tarjeta
- Naranja: QR/Digital

### 27.2 Gradientes

```css
bg-gradient-to-br from-{color}-50 to-{color}-100
bg-gradient-to-r from-{color}-600 to-{color}-700
```

---

## üì± 28. ESTADOS LOCALSTORAGE

| Key | Contenido | Prop√≥sito | TTL |
|-----|-----------|-----------|-----|
| `caja_estado` | `{ abierta, turno, timestamp }` | Estado persistente de caja | 5 minutos |
| `caja_status_backup` | `{ estado, timestamp, canProcessSales, ... }` | Backup para modo offline | Sin l√≠mite |
| `metaDiaria` | N√∫mero | Meta de ventas del d√≠a | Sin l√≠mite |

---

## üî• 29. FUNCIONES DE EMERGENCIA

### 29.1 Resolver Inconsistencias

**Bot√≥n en:** `FormularioAperturaElegante` l√≠neas 211-236

**Endpoint:** `gestion_caja_completa.php?accion=cerrar_turno_emergencia`

**Prop√≥sito:** Cerrar turnos hu√©rfanos que quedaron abiertos por errores

**Cu√°ndo usar:** Solo si no se puede abrir caja por turno duplicado

### 29.2 Validaci√≥n de Turno √önico

**Endpoint:** `gestion_caja_completa.php?accion=validar_turno_unico`

**Prop√≥sito:** Verificar que solo haya 1 turno abierto por usuario

---

## üìä 30. M√âTRICAS Y KPIs

### 30.1 M√©tricas del Turno

- Monto de apertura
- Total entradas efectivo (ventas + ingresos manuales)
- Total salidas efectivo (solo egresos)
- Efectivo disponible/esperado
- Diferencia al cierre
- Duraci√≥n del turno
- Cantidad de transacciones
- Ventas por m√©todo de pago

### 30.2 M√©tricas del Historial

- Total de eventos
- Turnos √∫nicos
- Cierres exactos (diferencia = 0)
- Diferencia total acumulada
- Promedio de diferencias
- Cajeros √∫nicos
- Performance por cajero

---

## üéØ 31. CASOS DE USO PRINCIPALES

### 31.1 Apertura Normal

1. Usuario abre la aplicaci√≥n
2. Ve "Caja Cerrada"
3. Click en "Abrir Caja"
4. Ingresa monto inicial (sugerido del √∫ltimo cierre)
5. Si hay cierre anterior: cuenta efectivo f√≠sico y verifica
6. Caja abierta, puede operar

### 31.2 Cierre Normal

1. Usuario termina turno
2. Click en "Cerrar Caja"
3. Ve resumen completo del turno
4. Cuenta efectivo f√≠sico en caja
5. Ingresa monto contado
6. Sistema calcula diferencia autom√°ticamente
7. Confirma cierre
8. Ve resumen final

### 31.3 Registro de Movimiento

1. Usuario necesita registrar ingreso/egreso
2. Selecciona tipo (Ingreso/Egreso)
3. Selecciona categor√≠a
4. Ingresa monto y descripci√≥n
5. Registra movimiento
6. Actualiza en tiempo real

---

## üîç 32. LOGS Y DEBUGGING

### 32.1 Console Logs Importantes

```javascript
'üîç C√ÅLCULO EFECTIVO ESPERADO:' - calcularEfectivoEsperado()
'üî• CALCULANDO EFECTIVO REAL' - calcularEfectivoRealPeriodo()
'üîí Enviando datos de cierre:' - procesarCierreCaja()
'üìä [CajaContext] Estado recibido:' - CajaContext
'‚úÖ [CajaService] Estado obtenido' - cajaService
'üö´ [useCajaStatus] Circuit Breaker ACTIVO' - Circuit breaker
```

### 32.2 Error Logs Backend

```php
error_log("GESTION_CAJA: " . $_SERVER['REQUEST_METHOD'])
error_log("üîç C√ÅLCULO EFECTIVO TE√ìRICO: ...")
error_log('[FINTECH_ALERT] SLA_BREACH: ...')
```

---

## ‚ö†Ô∏è 33. ERRORES COMUNES Y SOLUCIONES

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| "Ya hay un turno abierto" | Turno no se cerr√≥ correctamente | Usar "Resolver Inconsistencias" |
| "Efectivo esperado incorrecto" | C√°lculo desactualizado | Verificar funci√≥n `calcularEfectivoEsperado()` |
| "No hay turno activo" | Caja cerrada | Abrir caja primero |
| Diferencias grandes al cerrar | Movimientos no registrados | Revisar movimientos del turno |
| Circuit breaker activo | M√∫ltiples errores de API | Esperar 30 segundos o refresh manual |

---

## üéì 34. GLOSARIO DE T√âRMINOS

- **Turno:** Per√≠odo desde apertura hasta cierre de caja
- **Efectivo te√≥rico:** Efectivo que DEBE haber seg√∫n registros
- **Efectivo contado:** Efectivo f√≠sico realmente presente
- **Diferencia:** Efectivo contado - Efectivo te√≥rico
- **Sobrante:** Diferencia positiva (hay m√°s efectivo)
- **Faltante:** Diferencia negativa (falta efectivo)
- **Movimiento manual:** Ingreso/egreso registrado manualmente
- **Arqueo:** Conteo f√≠sico de efectivo
- **Balance acumulativo:** Efectivo real que va cambiando entre eventos

---

## üìã 35. CHECKLIST DE MODIFICACIONES

Antes de modificar CUALQUIER archivo de Control de Caja:

- [ ] Leer este documento completo
- [ ] Identificar todos los archivos afectados
- [ ] Crear backup de archivos a modificar (carpeta `backups/`)
- [ ] Leer el archivo completo que vas a modificar
- [ ] Verificar funciones de c√°lculo cr√≠ticas
- [ ] Probar en desarrollo con datos reales
- [ ] Validar apertura de caja
- [ ] Validar cierre de caja con diferencia = 0
- [ ] Validar cierre con sobrante
- [ ] Validar cierre con faltante
- [ ] Validar movimientos manuales
- [ ] Verificar historial de turnos
- [ ] Verificar integridad financiera
- [ ] Actualizar esta documentaci√≥n si corresponde

---

## üéØ 36. DEPENDENCIAS DE ARCHIVOS

### Dependencias de GestionCajaMejorada.jsx

```
GestionCajaMejorada.jsx
‚îú‚îÄ AuthContext (useAuth)
‚îú‚îÄ CONFIG (API_URL)
‚îú‚îÄ lucide-react (20+ iconos)
‚îú‚îÄ API: gestion_caja_completa.php
‚îÇ   ‚îú‚îÄ GET: estado_caja
‚îÇ   ‚îú‚îÄ GET: historial_movimientos
‚îÇ   ‚îú‚îÄ GET: ultimo_cierre
‚îÇ   ‚îú‚îÄ POST: abrir_caja
‚îÇ   ‚îú‚îÄ POST: cerrar_caja
‚îÇ   ‚îú‚îÄ POST: registrar_movimiento
‚îÇ   ‚îî‚îÄ POST: cerrar_turno_emergencia
‚îî‚îÄ API: pos_status.php (para verificaciones)
```

### Dependencias de HistorialTurnosPage.jsx

```
HistorialTurnosPage.jsx
‚îú‚îÄ AuthContext (user)
‚îú‚îÄ CONFIG
‚îú‚îÄ ReportesEfectivoPeriodo.jsx
‚îú‚îÄ ReportesDiferenciasCajero.jsx
‚îú‚îÄ API: gestion_caja_completa.php
‚îÇ   ‚îú‚îÄ GET: historial_completo (con filtros y paginaci√≥n)
‚îÇ   ‚îî‚îÄ GET: resumen_movimientos_turno
‚îî‚îÄ API: pos_status.php (efectivo real actual)
```

### Dependencias de CajaContext.jsx

```
CajaContext.jsx
‚îú‚îÄ AuthContext (user)
‚îú‚îÄ CONFIG
‚îú‚îÄ localStorage (persistencia)
‚îî‚îÄ API: gestion_caja_completa.php
    ‚îú‚îÄ GET: estado_caja
    ‚îú‚îÄ POST: abrir_caja
    ‚îî‚îÄ POST: cerrar_caja
```

---

## üîÑ 37. INTEGRACI√ìN CON M√ìDULO DE VENTAS

### Cuando se procesa una venta:

```
PuntoDeVenta.jsx ‚Üí procesar venta
    ‚Üì
API: procesar_venta_ultra_rapida.php
    ‚Üì
Backend actualiza turnos_caja:
  - Si metodo_pago = 'efectivo': += ventas_efectivo
  - Si metodo_pago = 'tarjeta': += ventas_tarjeta
  - Si metodo_pago = 'transferencia': += ventas_transferencia
  - Si metodo_pago = 'qr': += ventas_qr
  - Recalcula efectivo_teorico
    ‚Üì
CajaContext detecta cambio en pr√≥ximo refresh
```

---

## üìñ 38. ARCHIVOS DE DOCUMENTACI√ìN RELACIONADOS

- `SISTEMA_EMPRESARIAL_DOBLE_TURNO_IMPLEMENTADO.md` - Sistema de turnos
- `CASH_SYSTEM_IMPLEMENTATION_REPORT.md` - Implementaci√≥n del sistema de caja
- `CASH_CLOSURE_FINAL_SOLUTION_REPORT.md` - Soluci√≥n de cierres
- `AUDITORIA_SISTEMA_AEROSPACE_GRADE_FINAL.md` - Auditor√≠a completa

---

## ‚úÖ 39. VALIDACIONES REALIZADAS

Este mapa fue creado analizando:
- ‚úÖ 7 componentes frontend completos
- ‚úÖ 4 hooks personalizados
- ‚úÖ 1 servicio completo
- ‚úÖ 2 contextos de React
- ‚úÖ 1 archivo backend principal (1330+ l√≠neas)
- ‚úÖ 4 tablas de base de datos
- ‚úÖ 15+ funciones de API
- ‚úÖ 10+ archivos de testing

**Total de l√≠neas de c√≥digo analizadas:** ~6000+ LOC

---

## üîê 40. NIVEL DE CRITICIDAD

**NIVEL:** üî¥ **CR√çTICO - M√ÅXIMA PRECAUCI√ìN**

Este m√≥dulo maneja:
- üí∞ Dinero f√≠sico real
- üìä Balance financiero del negocio
- üîí Seguridad de efectivo
- üìà Trazabilidad contable
- üë• Responsabilidad de cajeros

**Cualquier error puede causar:**
- Descuadres financieros
- P√©rdida de dinero
- Falta de trazabilidad
- Problemas de auditor√≠a
- Responsabilidad legal

---

**Documento creado por:** AI Assistant  
**Fecha:** 8 de Octubre, 2025  
**Versi√≥n:** 1.0  
**Estado:** ‚úÖ COMPLETO Y VALIDADO  
**Nivel de an√°lisis:** üî¨ MILIM√âTRICO - AEROSPACE GRADE


